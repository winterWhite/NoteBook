## 第一课：Quick Start

访问网站的过程，HTTP都做了什么？    

- 输入网址（web客户端发送HTTP请求报文，在地址栏输入的内容叫做URI，通常情况下都使用的是URL这种类型的地址，地址的内容包括了协议名称、web服务器名称、资源地址）
- 等待网站响应（通常情况下这个过程是比较短暂的，但web服务器却做的不少）
	- web服务器接收到请求以后，通过URL地址照到对应的资源，然后发送HTTP响应报文，响应的内容有：响应状态码、资源类型（MIME）、资源长度、资源内容。。。
	- web客户端接收响应信息，根据其中的资源类型对资源进行解析，并按照其格式显示为网页或其他资源类型
	
整个过程中，涉及到的知识：URL、HTTP状态码、MIME格式

一个单独的网页，通常情况下会有多个HTTP请求，包括HTML页面请求、页面的内嵌资源：如js、css文件、图片文件、视频音频文件等等    

HTTP报文只有两种：请求报文、响应报文；两种报文都是由简单的字符串组成，分为以下三个部分：

- 起始行（即报文的第一行）
	- 对于请求报文，起始行用于说明要做什么（HTTP方法、请求内容）
	- 对于响应报文，起始行用于说明出现了什么情况（响应状态码）
- 首部字段（起始行后面跟着的0个或多个名值对，用冒号分隔；首部以一个空行结束）
- 主体
	- 请求报文：要发送给服务器的数据（对于get请求就没有此内容）
	- 响应报文：返回给客户端的数据（可以是任何类型的文件，如HTML、Txt）

HTTP报文的转送——TCP/IP协议，HTTP协议建立在TCP协议之上，也就是说，在发送HTTP报文之前，web客户端与web服务器之间会通过URL建立一条TCP连接，建立的过程运用到DNS域名服务器解析。

使用Telnet命令建立TCP链接并测试HTTP请求的响应内容，模拟HTTP客户端。

web应用程序（除web浏览器、web服务器之外的）

- 代理（位于客户端和服务器之间，接收所有客户端的HTTP请求并转发给服务器，也就是代表客户端与服务器进行通信，代理可对请求和响应进行过滤）
- 缓存（将经过代理请求的文档复制保存起来，下一次访问时可直接访问副本）
- 网关（可将HTTP流量转换为其他协议）
- 隧道（对原始信息进行盲转发，通常用于加密）
- Agent代理（代表用户发起HTTP协议的应用程序，比如web浏览器、网络爬虫就是一种Agent代理）

## 第二课：URL

URL作为URI的一个子集，它主要通过资源的位置来进行标识资源；URI的另一个比较主要的子集URN则是通过名字来进行识别。

URL可分为三个部分：

- URL方案：此部分告知web客户端怎样访问资源，即使用什么协议，对于HTTP访问则是HTTP协议
- 服务器位置：此部分告知web客户端资源位于何处，可以是服务器域名也可以是IP地址
- 资源路径：此部分告知web客户端资源所在服务器本地的具体路径

具体来说：方案+主机+路径    
同时URL也可以通过其他的协议来访问资源。

URL语法:

<pre>
	方案://用户名:密码@主机:端口/路径;参数?查询字符串#页面片段
</pre>

对于HTTP协议，常用的是“主机:端口”、“路径:参数”、“查询字符串”、“页面片段”

URL的快捷方式：相对URL（在资源内部使用），关于如何在绝对URL和相对URL之间进行切换，需要涉及到基础URL，基础URL的位置有两种提供方式：
	
- 资源中显示提供：通过<base>标签指定页面中所有相对URL的基础URL
- 封装资源的基础URL：当没有显示指定时，一般将该资源的所属资源的URL作为基础URL
- 无基础URL：此时则会出现问题，该URL无效

相对URL的解析过程可用如下的流程图解释：
![](./URL.png)

自动扩展URL功能：

- 主机名扩展
- 历史扩展

URL编码机制：ASCII码+转义字符，转义字符用来表示不安全字符，同时有一些被保留受限的一些字符：
![](./URL1.png)

## 第三课：HTTP报文

请求报文的语法格式：

	<方法> <请求URL> <版本>
	<首部信息>
	<主体信息>

响应报文的语法格式：

	<版本> <状态码> <原因短语>
	<首部>
	<主体>

常用的**HTTP方法**：

- GET：从服务器获取资源
- POST：向服务器发送数据
- PUT：将主体信息储存在服务器
- DELETE：从服务器删除资源
- OPTIONS：决定可以在服务器执行哪些方法
- HEAD：只从服务器获取文档的首部
- Trace：追踪

并不是所有的浏览器都实现了衣裳的几种方法。在这些方法中，GET和HEAD方法被视为安全方法，即不会在HTTP服务器产生什么影响，GET和HEAD的区别就在于，HEAD请求的响应只返回首部的内容，而不返回主体。

使用HEAD请求的作用有：

- 在不获取资源的情况下查看资源的相关信息
- 通过查看响应码判定资源是否存在
- 通过查看首部测试资源是否被修改

除这些HTTP方法外，HTTP还支持扩展方法，可以自己编写HTTP扩展方法实现一些现有HTTP标准方法所不能实现的功能，如MOVE方法可以移动服务器资源

HTTP**响应状态码**：
![](./status.png)
最常见的两种状态码：200（成功）、404（NOT FOUND）

100 continue状态码用于当客户端想要向服务器端发送大容量的主体时才使用，且只有HTTP1.1版本才支持此状态

300重定向状态码，通过响应报文的location首部可告知资源的新位置

400范围为客户端错误状态码，500范围为服务器端错误状态码

**HTTP首部**字段：向请求信息或响应信息添加一些附加说明的内容，一般以名值对的形式出现，首部可分为通用首部（请求报文和响应报文都有的，如DATE）、请求首部、响应首部、实体首部、扩展首部，

常用的首部有：Date、Content-length、Content-type（用于描述实体内容，为实体首部）、Accept（客户端希望接受什么类型的资源，请求首部）

请求首部分为：Accept首部、条件请求首部、安全请求首部、代理请求首部    
响应请求首部：协商首部、安全响应首部    
实体首部：内容首部（content系列）、实体缓存首部

## 第四课：连接管理

HTTP连接是HTTP报文传输的关键通道，在编写HTTP应用程序时必须对此有深刻的理解。几乎所有的HTTP连接都是TCP链接，TCP连接是因特网上的可靠连接。从浏览器接收到用户输入的网址时，首先要建立TCP连接，其过程分为以下几个步骤：

- 从URL中解析主机名
- 查询主机名的IP地址（DNS）
- 获取端口号（默认为80）
- 发起到某IP的某端口的连接
- 浏览器发送HTTP请求报文
- 浏览器读取HTTP响应报文
- 关闭连接

TCP为HTTP提供一条可靠的的比特传输管道，使得从TCP一端输入的字节在另一端以原有的顺序正确的传送出来。TCP数据又是通过IP分组的小数据块来发送的，因此整个协议栈即HTTP over TCP over IP，HTTP的安全版本HTTPs就是在HTTP与TCP的中间插入了一层（TLS或SSL）的密码加密层。

TCP通过四个值识别应用程序：
<源IP地址> <源端口号> <目的IP地址> <目的端口号>    
这四个值唯一标志了一条TCP连接，两个不同的连接不可能四个值都相同。

TCP套接字编程：
![](./TCP.png)

HTTP连接的性能问题：HTTP位于TCP端的上层，因此TCP端的性能问题会直接影响到HTTP的性能，对于一次HTTP连接来说，产生的时延主要有以下几种情况：

- 查询服务器IP地址和端口号的时延（DNS）
- 建立TCP连接的时延
- 服务器处理报文的时延
- 服务器会送报文的时延

TCP握手时延：当小的HTTP事务会在TCP握手时延上耽搁过多的时间

**HTTP连接处理**：

HTTP的Connection首部：通过一个由逗号分隔的连接标签列表来为连接指定一些不会传播到其他连接中去的选项，这些标签可分为下列3类：

- HTTP首部字段名，列出只与此连接有关的首部，转发之前必须删除列出的首部
- 任意标签值，用于描述此连接的非标准选项
- 值close，说明操作完成之后须关闭这条持久链接

串行连接会将时延叠加起来，因此性能极差，以下几种方法可以提高HTTP连接性能：

- 并行连接：如加载一个页面时，并行发起几个连接分别用于请求HTML页面以及内嵌的一些资源。并行连接的缺点：占用内存，在网速较慢时不一定就比串行速度快，TCP慢启动的存在使得新连接的传输速度慢，可打开的并行连接数量是有限的。
- 持久连接：在事务处理结束后仍然保持TCP连接，缺点：可能导致大量空闲连接（Keep-Alive）通过Connection：Keep-Alive首部可请求一条连接保持在打开状态，如果服务器端可以打开一条持久连接则在响应报文的首部加上Connection：Keep-Alive。Keep-Alive选项：timeout，keep-alive响应首部中服务器希望将连接保持活跃的时间；max，希望为多少事务保持连接活跃。Keep-Alive选项是可选的，只有在Connection：Keep-Alive首部存在时才可用。
- 管道化连接：管道化连接是建立在持久连接上的，如果不能保证是持久连接就不能请求管道化连接
- 复用连接

连接的关闭：

- 任意解除连接，这种情况可能发生在资源传输尚未完成时，此时就要依靠响应报文中的Content-length首部进行判定是否资源是完整的，所以每条HTTP响应报文都应该有精确的Content-length首部。

	事务分为幂等和非幂等，幂等的事务表示不论执行多少次，结果都相同，而非幂等则相反。客户端不应该以管道化方式传送非幂等的事务请求。

- 正常关闭连接，TCP连接有两条信道（输入和输出），使用套接字调用close方法会将两条信道都关闭，成为完全关闭；也可调用shutdown方法关闭其中的一条，称为半关闭。关闭连接的输出信道相对安全，而关闭输入信道则比较危险。

	要实现正常关闭，一般应首先关闭输出信道，然后等待它的另一端关闭其输出信道，然后再完全关闭

## 第五课：Web服务器

Web服务器的形式：

- 可安装在系统上的软件web服务器（如Apache、iPlanet）
- web服务器设备（一台预先安装好服务器软件的计算机）
- 计算机芯片嵌入式web服务器（一般潜入消费类产品，如打印机）

web服务器会做什么：

- 建立连接——接受客户端连接或关闭连接
- 接收请求——从网络中读取HTTP请求报文
- 处理请求——对请求报文进行解释，并采取行动
- 访问资源——访问报文中指定的资源
- 构建响应——创建带有正确首部的HTTP响应报文
- 发送响应——将响应发送给客户端
- 记录事务处理过程——将已完成的事务记录在日志中

新连接的建立：建立连接——判断客户端IP——添加至连接列表——监视连接

服务器的分类：

- 单线程的web服务器：一次只处理一个事务知道结束
- 多进程/多线程的web服务器
- 复用I/O的服务器
- 复用的多线程web服务器