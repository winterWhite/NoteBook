# 第1章：简介

MongoDB是面向文档的数据库，而非关系型数据库；其基本思路是将原本的“行”概念换成更加灵活的“文档”模型，这种方式可以将文档或者数组内嵌进来，可实现一条记录就可以表示非常复杂的层次关系；MongoDB所采用的面向文档的数据模型使其可以自动在多台服务器之间分割数据，还可以平衡集群的数据和负载，自动重排文档，十分有利于扩展；MongoDB具有丰富的功能，如索引功能、存储javascript、聚合、固定集合、文件存储等等；另外MongoDB具有卓越的性能且简化了数据库的管理。

# 第2章：入门

## 2.1 文档

文档是MongoDB中数据的基本单元，有些类似于关系数据库中的行（但比行更复杂），多个键及其关联的值有序的放在一起就是文档，在javascript里将文档表示为对象，如下：

	{"greeting": "Hello World!"}
这个文档只包含一个键值对，但通常的情况下一个文档包含多个键值对。

* 文档中的键值对是有序的，也就是说如果排列不一样，而内容一样的文档也是不一样的文档。如

		{"greeting": "Hello World!", "foo": 1}
		{"foo": 1, "greeting": "Hello World!"}
上面两个文档是不一样的。
* 文档键的值可是是各种数据类型
* 键不能含有\0（空字符），这个字符用于表示键的结尾
* .和$有特殊意义，只有在特定环境下才能使用
* 以下划线_开头的键是保留的，但不严格要求

MongoDB不但区分类型，也区分大小写，且MongoDB不能有重复的键。

## 2.2 集合

集合就是一组文档。如果文档相当于行，那么集合就相当于表

### 2.2.1 无模式

集合是无模式的，这意味着集合中的文档可以是各式各样的，但是在正是使用时还是要对文档进行分类和划分模式，这样便于管理和查询。

### 2.2.2 命名

集合名必须满足以下条件：
1. 集合名不能是空字符串""
2. 集合名不能含有\0空字符，此字符表示集合名的结尾
3. 集合名不能以“system.”开头，这是为系统集合保留的前缀
4. 用户创建的集合名字不能含有保留字符$

**子集合**：组织集合的一种惯例是使用“.”字符分开的按命名空间划分的子集。

## 2.3 数据库

MongoDB中多个文档组成集合，而多个集合组成数据库。一个MongoDB实例可承载多个数据库，且相互之间是独立的，都有独立的权限控制，放置在不同的文件中。

数据库名必须满足以下条件：
1. 不能是空字符
2. 不能含有' '(空格)、.、$、/、\、和\0
3. 应全部小写
4. 最多64字节

数据库名最终都会变为文件名，一些数据库名是保留的，如admin(root数据库)、local、config；将数据库的名字放到集合的前面使用.分隔开，则是集合的完全限定名，成为命名空间。

## 2.4 启动MongoDB

运行mongod.exe即可，默认情况下mongod会使用数据目录/data/db，并使用27017端口，如果数据目录不存在或不可写，服务器就会启动失败，所以在启动之前应先建立数据目录并保留对该目录的写权限。此外，mongod还会启动基本的HTTP服务器并监听端口28017，因此可通过http://localhost:28017来获取数据库管理信息。

## 2.5 MongoDB shell

MongoDB自带一个javascript shell，可以从命令行与MongoDB实例交互。启动方式，在命令行键入./mongo即可，必须保证在启动shell之前已经启动MongoDB。在shell中可以运行任何javascript程序，也可以调用定义javascript函数。

此外shell还提供类似SQL的语法操作：

	use dbname //使用dbname数据库，使用中的数据库有db指针指向

四种基本操作：

* 创建

	使用insert函数可添加文档到集合里：

		post = {
			"title": "My Blog",
			"content": "This is my blog."
			...
		}
		db.blog.insert(post)
* 读取

	find方法用于读取集合里所有的文档，若只想查看一个文档可使用方法findOne：

		db.blog.find()
	find和findOne可接受查询文档形式的限定条件。
* 更新

	update用于更新，其接收（至少）两个参数：
	1. 更新文档的限定条件
	2. 新的文档
* 删除

	remove用于从数据库中永久地删除文档，如果不使用参数，他也会删除一个集合中的所有文档

注：使用db.集合名来访问集合是个很好的方法，但如果集合名与数据库类的一个属性名则导致无法使用，则在给集合命名的时候要杜绝数据库的属性以及函数名，此时需要使用db.getCollection("集合名")才能访问到。同时要查看在javascript中无效的集合名如foo-bar时也可以使用此方法，

## 2.6 数据类型

### 2.6.1 基本数据类型

MongoDB的文档类似于JSON，在概念上和JavaScript中的对象相似，但JSON的表现能力有限只有六种数据类型，MongoDB在保留JSON基本的键值对基础上还添加了一些其他的数据类型：

1. null 用于表示空值或者不存在的字段，在shell中的表示方式如下：

		{"x": null}
2. 布尔：包括true和false两种值

		{"x": true}
3. 32位整数：在shell中不支持此类的，灰自动转换成64位
4. 64位整数：shell同样不支持，会使用特殊的内嵌文档来显示
5. 64位浮点数：shell中的所有数字都是此类型

		{"x": 3.14} 
		{"x": 3}都是浮点数
6. 字符串：
7. 符号：shell不支持
8. 对象id：是文档的12字节的唯一ID：
	
		{"x": ObjectId()}
9. 日期：从标准纪元开始的毫秒数

		{"x": new Date()}
10. 正则表达式：采用javascript正则表达方式：/xxf/i
11. 代码：

		{"x": function(){ /*...*/ }}
12. 二进制数据：shell中无法使用
13. 最大值、最小值：shell中无法使用
14. 未定义：

		{"x": undifined}
15. 数组：

		{"x": ["a", "b", "c"]}
16. 内嵌文档：

		{"x": {"foo" : "bar"}}

### 2.6.2 数字

JavaScript只有一种类型的数字，而MongoDB有三种数字类型，默认情况下shell里面的数字为双精度，所以如果你在shell中读取修改并保存后即使是原本32位数也会变为浮点数，所以不提倡在shell中对文档进行全覆盖。另外，shell中保存的64位浮点数可能会不准确，此时shell会添加两个键：top和bottom

### 2.6.3 日期

使用日期类型的数据需要创建一个Date对象，用到new Date(...)而不是Date(...)

### 2.6.4 _id和ObjectId

在MongoDB中存储的文档都必须有一个"_id"键，默认是ObjectId类型，此键在一个集合之中应该是唯一的，如果在插入文档时没有设置"_id"键的话系统会自动生成一个键。

# 第3章：创建、更新及删除文档

## 3.1 插入并保存文档

插入是想MongoDB中添加数据的基本方法，通常使用insert函数：db.blog.insert(...)

### 3.1.1 批量插入

批量插入能传递一个由文档构成的数组给数据库。

### 3.1.2 插入原理及作用

插入时，驱动程序会将数据转换成BSON格式并将其送入数据库，数据库解析BSON并检查是否包含"_id"键和是否大于4mb，然后即将数据存入数据库中。

## 3.2 删除

删除的方式是使用remove函数：db.user.remove()，当不传入参数时会删除该集合中的所有文档但不删除集合本身，如果传入一个查询文档则只删除符合条件的文档，删除数据是永久性的，不能撤销也不能恢复。

删除集合会更加快速地删除该集合下的所有文档：

	db = Connection().foo;
	collection = db.bar
	colection.remove

## 3.3 更新

文档存入数据库后可以使用update修改它，update有两个参数，一个是查询文档，一个是修改器文档。

### 3.3.1 文档替换

	var jar = db.user.findOne({"name": "jar"});//获取要修改的文档
	jar.newCore = {...};
	jar.username = jar.name;
	delete jar.name; //做出的一系列修改
	db.user.update({"name": "jar"}, jar); //使用update方法更新文档
### 3.3.2 修改器

更新修改器是一种特殊的键，用于指定复杂的更新操作，比如调整、增加或删除键

$set：此键用于指定一个值，如果该键不存在则创建他。   
$unset: 用于指定一个值，如果该键存在则删除他   
$inc: 用于增加已有键的值，或者在键不存在时创建他   
$push: 用于数组键，如果指定的键已经存在则会向已有数组添加一个元素，如果没有则创建一个数组。   
$ne: 如果一个值不在数组里面则将其添加进去   
$addToSet:同上   
$each:    
$pop: 从数组的任何一端删除元素：{$pop, {key: 1}}从末尾删，{$pop, {key: -1}}从头删   
$pull: 基于特定条件删除元素
 
### 3.3.3 upsert

upsert是一种特殊的更新，如果没有符合更新条件的文档，则会以这个条件和更新文档为基础创建一个文档，如果找到了匹配的文档则正常更新。